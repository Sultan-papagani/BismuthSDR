#pragma once

#include "drawer_interface.h"
#include "sdr_manager.h"
#include "dsp/rotator.h"
#include "dsp/decimating_fir.h"
#include "RtAudio.h"
#include "dsp/dsp_math.h"
#include "dsp/mono_to_stereo.h"

#define FL_M_PI     3.1415926535f
#define DB_M_PI     3.14159265358979323846

class radio : public drawer_interface
{
    public:
        radio();
        ~radio();
        void init() override;
        void draw() override;
        void destroy() override;
        const char* get_name() override;

        bool running = false;

        decimating_fir* fir;
        decimating_fir* fir_fm;

        rotator* _rotator;
        double offset = 92000000;

        float* fftWindow;

        float phase = 0.0f;

        double_buffer<complex>* input;
        double_buffer<complex>* selected_source = nullptr;
        std::vector<std::string> sdr_list;
        std::vector<std::string> stream_names;

        double_buffer<complex> work_buffer{"work", };
        float invDeviation;

        RtAudio dac;
        int actualCallback(void *outputBuffer, void *inputBuffer, unsigned int nBufferFrames, double streamTime, RtAudioStreamStatus status, void *userData );

        mono_to_stereo stereo_converter;

        complex* ring_buffer;
        int reader = 0;
        int writer = 0;
        int size;

        const unsigned int fir_16_8_len = 72;
        const float fir_16_8_taps[72] = {
        0.000003688211243,
        0.000013660745184,
        0.000027864244875,
        0.000056024595736,
        0.000099948148808,
        0.000168552197041,
        0.000269382284025,
        0.000413325712010,
        0.000612084815649,
        0.000879405538662,
        0.001230104825804,
        0.001680092905716,
        0.002245658820654,
        0.002942957882659,
        0.003787212583021,
        0.004791922493325,
        0.005967969572298,
        0.007322738536994,
        0.008859256322921,
        0.010575423925694,
        0.012463379308760,
        0.014509046778473,
        0.016691912242846,
        0.018985060458242,
        0.021355495646189,
        0.023764754477139,
        0.026169804021396,
        0.028524201614471,
        0.030779477612194,
        0.032886687871454,
        0.034798070863046,
        0.036468735790737,
        0.037858303447209,
        0.038932421304764,
        0.039664078609141,
        0.040034655893826,
        0.040034655893826,
        0.039664078609141,
        0.038932421304764,
        0.037858303447209,
        0.036468735790737,
        0.034798070863046,
        0.032886687871454,
        0.030779477612194,
        0.028524201614471,
        0.026169804021396,
        0.023764754477139,
        0.021355495646189,
        0.018985060458242,
        0.016691912242846,
        0.014509046778473,
        0.012463379308760,
        0.010575423925694,
        0.008859256322921,
        0.007322738536994,
        0.005967969572298,
        0.004791922493325,
        0.003787212583021,
        0.002942957882659,
        0.002245658820654,
        0.001680092905716,
        0.001230104825804,
        0.000879405538662,
        0.000612084815649,
        0.000413325712010,
        0.000269382284025,
        0.000168552197041,
        0.000099948148808,
        0.000056024595736,
        0.000027864244875,
        0.000013660745184,
        0.000003688211243,

        };

        const unsigned int fir_2_2_len = 69;
        const float fir_2_2_taps[69] = {
        0.000400633624864,
        0.002075598505552,
        0.004856364956715,
        0.005979016698235,
        0.002622922607902,
        -0.002718259152577,
        -0.003381533671376,
        0.001638638539759,
        0.004081814705993,
        -0.000984029228217,
        -0.005120988470135,
        0.000177440907285,
        0.006425852662023,
        0.001009351602305,
        -0.007912827910006,
        -0.002713700675199,
        0.009509311257450,
        0.005070635723474,
        -0.011154020477109,
        -0.008246059919867,
        0.012785716787299,
        0.012487906837156,
        -0.014347452386709,
        -0.018205770848481,
        0.015781858576801,
        0.026172374716730,
        -0.017037643409603,
        -0.038051489304887,
        0.018067070624730,
        0.058212412671604,
        -0.018832304184135,
        -0.102772486604899,
        0.019303165035556,
        0.317189488733641,
        0.480537520090363,
        0.317189488733641,
        0.019303165035556,
        -0.102772486604899,
        -0.018832304184135,
        0.058212412671604,
        0.018067070624730,
        -0.038051489304887,
        -0.017037643409603,
        0.026172374716730,
        0.015781858576801,
        -0.018205770848481,
        -0.014347452386709,
        0.012487906837156,
        0.012785716787299,
        -0.008246059919867,
        -0.011154020477109,
        0.005070635723474,
        0.009509311257450,
        -0.002713700675199,
        -0.007912827910006,
        0.001009351602305,
        0.006425852662023,
        0.000177440907285,
        -0.005120988470135,
        -0.000984029228217,
        0.004081814705993,
        0.001638638539759,
        -0.003381533671376,
        -0.002718259152577,
        0.002622922607902,
        0.005979016698235,
        0.004856364956715,
        0.002075598505552,
        0.000400633624864,
    };

        char name[50];
};